---
import Layout from "../layouts/Layout.astro";
import Footer from "../components/UI/Footer.astro";
import Container from "../components/UI/Container.tsx";
import { listProductCategories, listProducts, listCollections, listProductTags, listProductTypes } from "../lib/medusajs/products";
import { computePriceRangeFromProducts } from "../lib/meilisearch/converters";
import { parseIdList, parsePositiveNumber } from "../lib/utils";

const url = new URL(Astro.request.url);

const selectedCategoryIds = parseIdList(url, "category_id");
const selectedTagIds = parseIdList(url, "tag", "tag_id", "tags");
const [collectionCandidate] = parseIdList(url, "collection_id", "collection");
const [typeCandidate] = parseIdList(url, "type_id", "type");
const initialMaxPrice = parsePositiveNumber(url.searchParams.get("max_price"));

const [categoriesResponse, collectionsResponse, tagsResponse, typesResponse] = await Promise.all([listProductCategories({ limit: 50 }), listCollections({ limit: 20 }), listProductTags({ limit: 100 }), listProductTypes({ limit: 50 })]);

const categories = categoriesResponse.product_categories ?? [];
const collections = collectionsResponse.collections ?? [];
const productTags = tagsResponse.product_tags ?? [];
const productTypes = typesResponse.product_types ?? [];

const resolvedCollectionId = collectionCandidate ? (collections.find((collection) => collection.id === collectionCandidate || collection.handle === collectionCandidate)?.id ?? collectionCandidate) : undefined;

const resolvedTypeId = typeCandidate ? (productTypes.find((type) => type.id === typeCandidate || type.value === typeCandidate)?.id ?? typeCandidate) : undefined;

const initialResultData = await listProducts({
    limit: 12,
    offset: 0,
    category_id: selectedCategoryIds.length ? selectedCategoryIds : undefined,
    collection_id: resolvedCollectionId ? [resolvedCollectionId] : undefined,
    tag_id: selectedTagIds.length ? selectedTagIds : undefined,
    type_id: resolvedTypeId ? [resolvedTypeId] : undefined,
}).catch((error) => {
    console.error("Error cargando el catálogo inicial", error);
    return {
        products: [],
        count: 0,
        limit: 12,
        offset: 0,
        priceRange: { min: 0, max: 100 },
    };
});

const initialResult = {
    ...initialResultData,
    priceRange: computePriceRangeFromProducts(initialResultData.products ?? []),
};
---

<Layout collections={collections}>
    <section class="site-container py-6 md:py-10 flex flex-col gap-3">
        <p class="text-sm uppercase tracking-[0.2em] text-text-secondary opacity-80">Catálogo</p>
        <h1 class="text-3xl md:text-4xl font-bold text-text-primary">Explora nuestros productos</h1>
        <p class="text-text-secondary max-w-3xl">Filtra por categoría y ajusta el rango de precios para encontrar la combinación perfecta para ti.</p>
    </section>

    <Container client:visible categories={categories} collections={collections} tags={productTags} types={productTypes} initialResult={initialResult} initialCategoryIds={selectedCategoryIds} initialCollectionId={resolvedCollectionId ?? null} initialTagIds={selectedTagIds} initialTypeId={resolvedTypeId ?? null} initialMaxPrice={initialMaxPrice} />

    <Footer />
</Layout>
