---
import Card from "./Card.tsx";
import { type StoreProduct } from "../../lib/medusajs/products";
interface Props {
    title?: string;
    focusText?: string;
    buttonText?: string;
    buttonHref?: string;
    products?: StoreProduct[];
    focusColor?: string;
    width?: string;
    height?: string;
}

const { title, focusText, buttonText, buttonHref = "/catalog", products = [], focusColor = "#299037" } = Astro.props;
---

<section class="card-section w-full rounded-2xl bg-linear-to-b from-[#f9fafb] via-white to-white py-8 shadow-sm sm:rounded-none sm:bg-transparent sm:py-12 sm:shadow-none">
    <div class="card-section__inner site-container space-y-8">
        <div class="card-section__header flex flex-wrap items-center justify-between gap-4">
            <h2 class="card-section__title text-2xl font-bold text-text-primary">
                {title}
                <span class="block text-primary sm:inline" style={`color: ${focusColor}`}>
                    {focusText}
                </span>
            </h2>
            {
                buttonText && (
                    <a href={buttonHref} class="relative inline-flex items-center justify-start py-3 pl-4 pr-12 overflow-hidden font-semibold text-primary transition-all duration-150 ease-in-out rounded hover:pl-10 hover:pr-6 bg-gray-50 group">
                        <span class="absolute bottom-0 left-0 w-full h-1 transition-all duration-150 ease-in-out bg-primary group-hover:h-full" />
                        <span class="absolute right-0 pr-4 duration-200 ease-out group-hover:translate-x-12">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                            </svg>
                        </span>
                        <span class="absolute left-0 pl-2.5 -translate-x-12 group-hover:translate-x-0 ease-out duration-200">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                            </svg>
                        </span>
                        <span class="relative w-full text-left transition-colors duration-200 ease-in-out group-hover:text-white">{buttonText}</span>
                    </a>
                )
            }
        </div>

        <div class="card-section__container relative w-full">
            <div class="card-section__slider flex snap-x snap-mandatory gap-4 overflow-x-auto pb-2 scroll-smooth sm:pb-4 md:grid md:grid-cols-[repeat(auto-fill,minmax(250px,1fr))] md:gap-6 md:overflow-visible md:snap-none">
                {
                    products.map((p) => (
                        <div class="card-section__item min-w-[85%] shrink-0 snap-start sm:min-w-[260px] md:min-w-0 md:shrink md:snap-none">
                            <Card product={p} client:load />
                        </div>
                    ))
                }
            </div>
        </div>

        <div class="card-section__dots mt-4 flex items-center justify-center gap-2 md:hidden"></div>
    </div>
</section>

<style>
    .card-section__slider {
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .card-section__slider::-webkit-scrollbar {
        display: none;
    }
</style>

<script>
    // Script para manejar los indicadores del slider en mobile
    function initSlider() {
        const containers = document.querySelectorAll(".card-section__container");

        containers.forEach((container) => {
            const slider = container.querySelector(".card-section__slider") as HTMLElement;
            const dotsContainer = container.parentElement?.querySelector(".card-section__dots") as HTMLElement;
            const items = slider.querySelectorAll(".card-section__item");

            if (!slider || !dotsContainer || items.length === 0) return;

            // Solo activar en mobile
            function isMobile() {
                return window.innerWidth <= 768;
            }

            // Crear dots
            function createDots() {
                if (!isMobile()) {
                    dotsContainer.innerHTML = "";
                    return;
                }

                dotsContainer.innerHTML = "";
                items.forEach((_, index) => {
                    const dot = document.createElement("button");
                    dot.className = "slider-dot";
                    dot.setAttribute("aria-label", `Ir al producto ${index + 1}`);
                    dot.addEventListener("click", () => scrollToItem(index));
                    dotsContainer.appendChild(dot);
                });
                updateActiveDot();
            }

            // Scroll a un item específico
            function scrollToItem(index: number) {
                const item = items[index] as HTMLElement;
                if (item) {
                    slider.scrollTo({
                        left: item.offsetLeft - slider.offsetLeft,
                        behavior: "smooth",
                    });
                }
            }

            // Actualizar dot activo
            function updateActiveDot() {
                if (!isMobile()) return;

                const dots = dotsContainer.querySelectorAll(".slider-dot");
                const scrollLeft = slider.scrollLeft;
                const itemWidth = (items[0] as HTMLElement).offsetWidth;
                const gap = 16; // 1rem en px
                const currentIndex = Math.round(scrollLeft / (itemWidth + gap));

                dots.forEach((dot, index) => {
                    dot.classList.toggle("active", index === currentIndex);
                });
            }

            // Event listeners
            slider.addEventListener("scroll", updateActiveDot);
            window.addEventListener("resize", () => {
                createDots();
                updateActiveDot();
            });

            // Inicializar
            createDots();
        });
    }

    // Ejecutar cuando el DOM esté listo
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initSlider);
    } else {
        initSlider();
    }
</script>

<style is:global>
    .slider-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #d1d5db;
        border: none;
        padding: 0;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .slider-dot.active {
        background-color: #299037;
        width: 24px;
        border-radius: 4px;
    }

    .slider-dot:hover {
        background-color: #9ca3af;
    }

    .slider-dot.active:hover {
        background-color: #207028;
    }
</style>
